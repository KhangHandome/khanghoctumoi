<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Há»c Tá»« Vá»±ng</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1e1e2f;
      color: #f0f0f0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #2c2c3e;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px #000;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .meaning {
      font-size: 1.2em;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .speak-button {
      background-color: #555;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 0.9em;
    }
    input[type=text], textarea, select {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      border: none;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    textarea {
      height: 100px;
    }
    .buttons {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    .hint { background: #3e3e5e; color: white; }
    .check { background: #4caf50; color: white; }
    .retry { background: #ff9800; color: white; }
    .add-topic { background: #2196f3; color: white; width: 100%; margin-top: 10px; }
    .add-word { background: #9c27b0; color: white; width: 100%; margin-top: 10px; }
    .upload-file { background: #00bcd4; color: white; width: 100%; margin-top: 10px; }
    .result { margin-top: 10px; font-weight: bold; }
    .score { margin-top: 10px; text-align: center; }
    .mistakes {
      margin-top: 20px;
      background: #444;
      padding: 10px;
      border-radius: 5px;
    }
    .mistakes h3 { margin-top: 0; }
    .word-list {
      margin-top: 20px;
      background: #333;
      padding: 10px;
      border-radius: 5px;
    }
    .word-list ul {
      padding-left: 20px;
    }
    .hint-display {
      margin-top: 10px;
      font-style: italic;
      color: #bbb;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Há»c Tá»« Vá»±ng</h1>
  <h2>Chá»n Chá»§ Äá»</h2>
  <select id="topicSelector" onchange="changeTopic()"></select>
  <button class="add-topic" onclick="addTopic()">â• ThÃªm Chá»§ Äá»</button>
  <button class="add-word" onclick="addMultipleWordsToTopic()">ğŸ“š ThÃªm Nhiá»u Tá»« VÃ o Chá»§ Äá»</button>
  <input type="file" id="fileInput" accept=".txt" onchange="loadWordsFromFile()" style="display: none;">
  <button class="upload-file" onclick="document.getElementById('fileInput').click()">ğŸ“„ Náº¡p Dá»¯ Liá»‡u Tá»« File .txt</button>
  <button class="upload-file" onclick="exportTopicsToFile()">ğŸ“¥ LÆ°u Dá»¯ Liá»‡u Ra File .txt</button>
  <div class="meaning">
    <span id="meaning">Äang táº£i...</span>
    <button class="speak-button" onclick="speakWord()">ğŸ”Š PhÃ¡t Ã¢m</button>
  </div>
  <div class="hint-display" id="hintDisplay"></div>
  <input type="text" id="answer" placeholder="GÃµ tá»« tiáº¿ng Anh á»Ÿ Ä‘Ã¢y" onkeydown="handleKey(event)">
  <div class="buttons">
    <button class="hint" onclick="showHint()">Gá»£i Ã½</button>
    <button class="check" onclick="checkAnswer()">Kiá»ƒm tra</button>
    <button class="retry" onclick="retryMistakes()" id="retryButton" style="display:none">Há»c láº¡i tá»« sai</button>
  </div>
  <div class="result" id="result"></div>
  <div class="score" id="score">Äiá»ƒm: 0</div>
  <div class="mistakes" id="mistakes" style="display:none">
    <h3>Tá»« sai:</h3>
    <ul id="mistakeList"></ul>
  </div>
  <div class="word-list">
    <h3 onclick="toggleWordList()" style="cursor:pointer">ğŸ“– Danh sÃ¡ch tá»« (báº¥m Ä‘á»ƒ áº©n/hiá»‡n)</h3>
    <ul id="wordList"></ul>
  </div>
</div>

<script>
let topics = {};
let selectedTopic = '';
let words = [];
let currentIndex = 0;
let score = 0;
let mistakes = [];
let currentWord = null;
let wordListVisible = true;
let hintIndex = 0;

function toggleWordList() {
  const list = document.getElementById("wordList");
  wordListVisible = !wordListVisible;
  list.style.display = wordListVisible ? "block" : "none";
}

function addTopic() {
  const name = prompt("Nháº­p tÃªn chá»§ Ä‘á» má»›i:");
  if (!name) return;
  if (topics[name]) {
    alert("Chá»§ Ä‘á» Ä‘Ã£ tá»“n táº¡i!");
    return;
  }
  topics[name] = [];
  const selector = document.getElementById("topicSelector");
  const option = document.createElement("option");
  option.value = name;
  option.text = name;
  selector.appendChild(option);
  selector.value = name;
  changeTopic();
}

function changeTopic() {
  selectedTopic = document.getElementById("topicSelector").value;
  words = [...topics[selectedTopic]];
  currentIndex = 0;
  score = 0;
  mistakes = [];
  hintIndex = 0;
  document.getElementById("score").innerText = "Äiá»ƒm: 0";
  document.getElementById("mistakes").style.display = "none";
  document.getElementById("retryButton").style.display = "none";
  document.getElementById("hintDisplay").innerText = "";
  updateWordList();
  nextWord();
}

function nextWord() {
  if (currentIndex >= words.length) {
    document.getElementById("meaning").innerText = "ÄÃ£ hoÃ n thÃ nh táº¥t cáº£ cÃ¡c tá»«!";
    document.getElementById("hintDisplay").innerText = "";
    currentWord = null;
    hintIndex = 0;
    return;
  }
  currentWord = words[currentIndex];
  document.getElementById("meaning").innerText = currentWord.vi;
  document.getElementById("answer").value = "";
  document.getElementById("hintDisplay").innerText = "";
  hintIndex = 0;
}

function checkAnswer() {
  const answer = document.getElementById("answer").value.trim();
  if (!currentWord) return;
  if (answer.toLowerCase() === currentWord.en.toLowerCase()) {
    score++;
    document.getElementById("result").innerText = "âœ… ChÃ­nh xÃ¡c!";
  } else {
    document.getElementById("result").innerText = `âŒ Sai! ÄÃ¡p Ã¡n Ä‘Ãºng: ${currentWord.en}`;
    mistakes.push(currentWord);
    const li = document.createElement("li");
    li.innerText = `${currentWord.vi} â†’ ${currentWord.en}`;
    document.getElementById("mistakeList").appendChild(li);
    document.getElementById("mistakes").style.display = "block";
    document.getElementById("retryButton").style.display = "block";
  }
  currentIndex++;
  document.getElementById("score").innerText = `Äiá»ƒm: ${score}`;
  nextWord();
}

function retryMistakes() {
  if (mistakes.length === 0) return;
  words = [...mistakes];
  mistakes = [];
  currentIndex = 0;
  score = 0;
  hintIndex = 0;
  document.getElementById("mistakeList").innerHTML = "";
  document.getElementById("mistakes").style.display = "none";
  document.getElementById("score").innerText = "Äiá»ƒm: 0";
  document.getElementById("hintDisplay").innerText = "";
  nextWord();
}

function handleKey(event) {
  if (event.key === "Enter") checkAnswer();
}

function showHint() {
  if (!currentWord) {
    document.getElementById("hintDisplay").innerText = "KhÃ´ng cÃ³ tá»« Ä‘á»ƒ hiá»ƒn thá»‹ gá»£i Ã½!";
    return;
  }
  if (hintIndex >= currentWord.en.length) {
    document.getElementById("hintDisplay").innerText = `Gá»£i Ã½: ${currentWord.en} (Ä‘Ã£ hiá»ƒn thá»‹ toÃ n bá»™ tá»«)`;
    return;
  }
  hintIndex++;
  const hint = currentWord.en.slice(0, hintIndex);
  document.getElementById("hintDisplay").innerText = `Gá»£i Ã½: ${hint}`;
}

function addMultipleWordsToTopic() {
  const input = prompt("Nháº­p danh sÃ¡ch tá»« theo Ä‘á»‹nh dáº¡ng:\nEnglish\tVietnamese\nmá»—i cáº·p trÃªn má»™t dÃ²ng:");
  if (!input) return;
  const lines = input.split('\n');
  let count = 0;
  lines.forEach(line => {
    const [en, vi] = line.split(/\t|\s{2,}/);
    if (en && vi) {
      topics[selectedTopic].push({ en: en.trim(), vi: vi.trim() });
      count++;
    }
  });
  alert(`ÄÃ£ thÃªm ${count} tá»« vÃ o chá»§ Ä‘á» '${selectedTopic}'.`);
  changeTopic();
}

function loadWordsFromFile() {
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const lines = e.target.result.split('\n');
    let currentTopic = "";
    let count = 0;

    lines.forEach(line => {
      line = line.trim();
      if (line.startsWith("###")) {
        currentTopic = line.replace(/^###\s*/, '').trim();
        if (!topics[currentTopic]) {
          topics[currentTopic] = [];
          const option = document.createElement("option");
          option.value = currentTopic;
          option.text = currentTopic;
          document.getElementById("topicSelector").appendChild(option);
        }
      } else if (line && currentTopic) {
        const [en, vi] = line.split(/\t|\s{2,}/);
        if (en && vi) {
          topics[currentTopic].push({ en: en.trim(), vi: vi.trim() });
          count++;
        }
      }
    });

    alert(`ÄÃ£ náº¡p ${count} tá»« tá»« file vÃ o ${Object.keys(topics).length} chá»§ Ä‘á».`);
    const selector = document.getElementById("topicSelector");
    if (selector.options.length > 0) {
      selector.value = selector.options[0].value;
      changeTopic();
    }
  };
  reader.readAsText(file);
}

function exportTopicsToFile() {
  if (Object.keys(topics).length === 0) {
    alert("ChÆ°a cÃ³ chá»§ Ä‘á» nÃ o Ä‘á»ƒ lÆ°u.");
    return;
  }

  let content = "";
  for (const [topic, wordList] of Object.entries(topics)) {
    content += `### ${topic}\n`;
    wordList.forEach(word => {
      content += `${word.en}\t${word.vi}\n`;
    });
    content += "\n";
  }

  const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "tu_vung.txt";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function speakWord() {
  const word = currentWord?.en || '';
  if (!word) return;
  const utterance = new SpeechSynthesisUtterance(word);
  utterance.lang = 'en-US';
  speechSynthesis.speak(utterance);
}

function updateWordList() {
  const list = document.getElementById("wordList");
  list.innerHTML = "";
  topics[selectedTopic].forEach(w => {
    const li = document.createElement("li");
    li.innerText = `${w.en} - ${w.vi}`;
    list.appendChild(li);
  });
  list.style.display = wordListVisible ? "block" : "none";
}
</script>
</body>
</html>
